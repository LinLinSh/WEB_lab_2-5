server {
    listen 80;
    server_name localhost;
    root /var/www/html;
    index index.php index.html;

    # Настройки безопасности
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Обработка статических файлов (изображения, CSS, JS, шрифты и т.д.)
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|txt)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Обработка PHP файлов
    # ВАЖНО: Этот блок должен быть до location / , иначе все запросы могут попасть сюда
    location ~ \.php$ {
        # Имя сервиса PHP из docker-compose.yml
        fastcgi_pass lab5_php:9000;
        fastcgi_index index.php;
        # Указываем путь к файлу на диске в контейнере
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        # Таймауты для стабильности
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Основной location для всех остальных запросов
    # ВАЖНО: должен быть самым последним
    location / {
        # Пытаемся найти файл или директорию на диске
        # Если не находим, направляем запрос на index.php (для PHP-роутинга)
        # Это позволяет работать с pretty URLs и подпапками, где есть index.php
        # Если в корне нет index.php, он всё равно будет направлен туда, где его нет - это может вызвать 404 или 500 в PHP, что нормально.
        # Главное - избежать циклического редиректа.
        # Старая строка из предыдущего скрипта была проблемной: try_files $uri $uri/ @fallback;
        # @fallback -> try_files /index.php =404; - это могло привести к циклу, если /index.php не существует или не может обработать маршрут.
        # Лучше использовать стандартный способ для PHP-приложений.
        # Проверим сначала, существует ли файл/директория.
        # Если нет, и путь не заканчивается на .php (иначе он попадёт в предыдущий блок ~ \.php$), направим на index.php в корне.
        # Это стандартный способ для многих PHP-фреймворков.
        try_files $uri $uri/ /index.php$is_args$args;
    }
}